___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "LinkedIn Conversion API by Addingwell",
  "brand": {
    "id": "brand_custom_template",
    "displayName": "Addingwell",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "This tag sends data from the GA4 client to LinkedIn Conversion API.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "SELECT",
    "name": "eventType",
    "displayName": "Event Type",
    "defaultValue": "page_view",
    "selectItems": [
      {
        "value": "page_view",
        "displayValue": "Page View"
      },
      {
        "value": "conversion",
        "displayValue": "Conversion"
      }
    ],
    "simpleValueType": true,
    "alwaysInSummary": true
  },
  {
    "type": "TEXT",
    "name": "conversionRuleUrn",
    "displayName": "Conversion Rule ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "conversion",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "accessToken",
    "displayName": "Access Token",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "conversion",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "eventDataListGroup",
    "displayName": "Event Data Override",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "serverEventDataList",
        "simpleTableColumns": [
          {
            "defaultValue": "currencyCode",
            "displayName": "Property Name",
            "name": "name",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "currencyCode",
                "displayValue": "Currency Code"
              },
              {
                "value": "amount",
                "displayValue": "Amount"
              }
            ],
            "valueValidators": [],
            "isUnique": true
          },
          {
            "defaultValue": "",
            "displayName": "Property Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "newRowButtonText": "Add Property"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "conversion",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "userDataListGroup",
    "displayName": "User Data Override",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "userDataList",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "SHA256_EMAIL",
            "displayName": "Property Name",
            "name": "name",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "SHA256_EMAIL",
                "displayValue": "Email Address"
              },
              {
                "value": "firstName",
                "displayValue": "First Name"
              },
              {
                "value": "lastName",
                "displayValue": "Last Name"
              },
              {
                "value": "countryCode",
                "displayValue": "Country Code"
              },
              {
                "value": "title",
                "displayValue": "Job Title"
              },
              {
                "value": "companyName",
                "displayValue": "Company Name"
              },
              {
                "value": "LINKEDIN_FIRST_PARTY_ADS_TRACKING_UUID",
                "displayValue": "LinkedIn First-Party UUID"
              },
              {
                "value": "ACXIOM_ID",
                "displayValue": "Acxiom ID"
              },
              {
                "value": "ORACLE_MOAT_ID",
                "displayValue": "Oracle Moat ID"
              }
            ],
            "isUnique": true
          },
          {
            "defaultValue": "",
            "displayName": "Property Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "newRowButtonText": "Add property"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "conversion",
        "type": "EQUALS"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const getAllEventData = require('getAllEventData');
const JSON = require('JSON');
const sendHttpRequest = require('sendHttpRequest');
const logToConsole = require('logToConsole');
const sha256Sync = require('sha256Sync');
const getRequestHeader = require('getRequestHeader');
const getType = require('getType');
const makeString = require('makeString');
const encodeUriComponent = require('encodeUriComponent');
const getTimestampMillis = require('getTimestampMillis');
const Math = require('Math');
const makeNumber = require('makeNumber');
const getCookieValues = require('getCookieValues');
const decodeUriComponent = require('decodeUriComponent');
const parseUrl = require('parseUrl');
const setCookie = require('setCookie');

const eventData = getAllEventData();

const user_data = eventData.user_data || {};
const user_address = user_data.address || {};

const api_url = "https://api.linkedin.com/rest/conversionEvents";

if(data.eventType == "conversion") {
  let user_data = getUserData();
  if(checkUserData(user_data)) {
    let postBody = getPostBody(user_data);
    sendConversionToLinkedIn(postBody);
  } else {
    return data.gtmOnSuccess();
  }
  
} else {
  const url = eventData.page_location || getRequestHeader('referer');

  if (url) {
    const value = parseUrl(url).searchParams.li_fat_id;

    if (value) {
      const options = {
        domain: 'auto',
        path: '/',
        secure: true,
        httpOnly: false,
        'max-age': 31556952000
      };

      setCookie('li_fat_id', value, options, false);
    }
  }
  return data.gtmOnSuccess();
}

function sendConversionToLinkedIn(postBody) {
  sendHttpRequest(
    api_url,
    (statusCode, headers, body) => {
      if (statusCode >= 200 && statusCode < 300) {
        data.gtmOnSuccess();
      } else {
        data.gtmOnFailure();
      }
    },
    {
      headers: getRequestHeaders(),
      method: 'POST'
    },
    JSON.stringify(postBody)
  );
}

function getRequestHeaders() {
  return {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + data.accessToken,
    'LinkedIn-Version': '202409'
  };
}

function getPostBody(user_data) {

  let conversionValue = {
    currencyCode: eventData.currency,
    amount: makeString(eventData.value)
  };
  
  if (data.serverEventDataList) {
    data.serverEventDataList.forEach(d => {
      conversionValue[d.name] = makeString(d.value);
    });
  }
  
  if(JSON.stringify(conversionValue) == "{}") conversionValue = undefined;
  
  let postBody = {
    conversion: 'urn:lla:llaPartnerConversion:' + data.conversionRuleUrn,
    conversionHappenedAt: Math.round(getTimestampMillis()),
    conversionValue: conversionValue,
    user: user_data
  };
    
  return postBody;
}

function getClickId() {
  return getCookieValues('li_fat_id')[0] ? decodeUriComponent(getCookieValues('li_fat_id')[0]) : undefined;
}

function getUserData() {
  
  let user_data = {};
  let address = {};
  let user_info = {};
  let user_ids = [
    {
      idType: "SHA256_EMAIL"
    },
    {
      idType: "LINKEDIN_FIRST_PARTY_ADS_TRACKING_UUID"
    },
    {
      idType: "ACXIOM_ID"
    },
    {
      idType: "ORACLE_MOAT_ID"
    }
  ];
  
   if (getType(eventData.user_data) === 'object') {
    user_data = eventData.user_data;
    const addressType = getType(user_data.address);
    if (addressType === 'object' || addressType === 'array') {
      address = user_data.address[0] || user_data.address;
    }
  }
  
  if(user_data) {
    
   if(user_data.email_address) {
     user_ids[0].idValue = hashData(user_data.email_address);
   } else if(user_data.email) {
     user_ids[0].idValue = hashData(user_data.email);
   } else if(user_data.sha256_email_address) {
     user_ids[0].idValue = hashData(user_data.sha256_email_address);
   }
    
   if(getClickId()) {
     user_ids[1].idValue = getClickId();
   }
    
   if(user_data.title) {
     user_info.title = user_data.title;
   }
    
   if(user_data.companyName) {
     user_info.companyName = user_data.companyName;
   }
    
   if(getType(address) == 'object') {
      
     if(address.first_name) {
       user_info.firstName = address.first_name;
     }
      
     if(address.last_name) {
       user_info.lastName = address.last_name;
     }

     if(address.country) {
       user_info.countryCode = address.country;
     }
      
   }
    
   if(getType(address) == 'array') {
    
     if(address[0].first_name) {
       user_info.firstName = address[0].first_name;
     }
    
     if(address[0].last_name) {
       user_info.lastName = address[0].last_name;
     }
    
     if(address[0].country) {
       user_info.countryCode = address[0].country;
     }
    
   }
  }
  
  if (data.userDataList) {
    data.userDataList.forEach(d => {
      if(d.name == "SHA256_EMAIL") {
        user_ids[0].idValue = hashData(d.value);
      } else if(d.name == "LINKEDIN_FIRST_PARTY_ADS_TRACKING_UUID"){
        user_ids[1].idValue = d.value;
      } else if(d.name == "ACXIOM_ID") {
        user_ids[2].idValue = d.value;
      } else if(d.name == "ORACLE_MOAT_ID") {
        user_ids[3].idValue = d.value;
      } else {
        user_info[d.name] = d.value;
      }
    });
  }
  
  for(let i = user_ids.length - 1; i >= 0; i--) {
    if(!user_ids[i].idValue) {
      user_ids.splice(i, 1);
    }
  }
  
  return {
    userInfo: JSON.stringify(user_info) != "{}" ? user_info : undefined,
    userIds: JSON.stringify(user_ids) != "[]" ? user_ids : undefined
  };
  
}

function checkUserData(user_data) {
  
  let send = true;
  
  if(user_data.userInfo && (!user_data.userInfo.firstName || !user_data.userInfo.lastName)) {
    send = false;
    logToConsole('You need to provide both firstName and lastName.');
  }
  
  if(!user_data.userIds) {
    send = false;
    logToConsole('You need to provide at least an email address.');
  }
  
  return send;
  
}


function isAlreadyHashed(input){
  return input && (input.toString().match('^[A-Fa-f0-9]{64}$') != null);
}

function hashData(input){
  if(input == null || isAlreadyHashed(input)){
    return input;
  }

  return sha256Sync(input.toString().trim().toLowerCase(), {outputEncoding: 'hex'});
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "trace-id"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "referer"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://api.linkedin.com/rest/conversionEvents"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "li_fat_id"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "li_fat_id"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 18/08/2022, 12:25:26


